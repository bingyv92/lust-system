# é”šç‚¹æ—¥æœŸé—®é¢˜è¯Šæ–­ä¸ä¿®å¤æŠ¥å‘Š

## é—®é¢˜æè¿°

ç”¨æˆ·æŠ¥å‘Šï¼š
- é”šç‚¹æ—¥æœŸè®¾ç½®ä¸º15æ—¶ï¼Œæ˜¾ç¤º"é»„ä½“æœŸç¬¬14å¤©"ï¼ŒçŠ¶æ€æ˜¾ç¤º"æ¯”è¾ƒç´¯"
- å°†é”šç‚¹æ—¥æœŸæ”¹ä¸º1åï¼Œä¾ç„¶æ˜¾ç¤º"é»„ä½“æœŸç¬¬14å¤©"ï¼Œä½†ç”Ÿç†å’Œå¿ƒç†çŠ¶æ€å˜ä¸º"æ­£å¸¸"

## æ ¹æœ¬åŸå› åˆ†æ

### é—®é¢˜1: é…ç½®ä¸Storageä¸åŒæ­¥ ğŸ”´

**é—®é¢˜æ ¸å¿ƒ**ï¼šç³»ç»Ÿå­˜åœ¨ä¸¤ä¸ªé”šç‚¹æ—¥æœŸæ¥æºï¼š

1. **é…ç½®æ–‡ä»¶** (`config.toml`)ï¼š
   ```toml
   [cycle]
   anchor_day = 1  # ç”¨æˆ·ä¿®æ”¹
   ```

2. **Plugin Storage** (`plugin_storage`):
   ```python
   anchor_day = plugin_storage.get("anchor_day", 15)  # ä»æ˜¯æ—§å€¼
   ```

**ä»£ç ä½ç½®**: [`core/state_manager.py:181-184`](core/state_manager.py:181)

```python
def _generate_new_cycle(self):
    # âš ï¸ åªä»storageè¯»å–ï¼Œä¸è¯»å–config
    anchor_day = plugin_storage.get("anchor_day", 15)
```

**åæœ**ï¼š
- ç”¨æˆ·ä¿®æ”¹configæ–‡ä»¶ä¸­çš„`anchor_day`
- ä½†åŒå‘¨æœŸç”Ÿæˆæ—¶ä»ä½¿ç”¨storageä¸­çš„æ—§å€¼
- å¯¼è‡´é”šç‚¹æ—¥æœŸä¿®æ”¹ä¸ç”Ÿæ•ˆ

---

### é—®é¢˜2: åŒå‘¨æœŸæ•°æ®ç¼“å­˜ ğŸŸ¡

**ç¼“å­˜æœºåˆ¶**: [`core/state_manager.py:160-179`](core/state_manager.py:160)

```python
def _load_or_generate_cycle(self):
    stored_cycle = plugin_storage.get("dual_cycle_data", None)
    if stored_cycle:
        self.current_cycle = DualCycleData.from_dict(stored_cycle)
        # åªæœ‰å½“å‘¨æœŸè¿‡æœŸæ—¶æ‰é‡æ–°ç”Ÿæˆ
        if today >= self.current_cycle.end_date:
            self._generate_new_cycle()
```

**åæœ**ï¼š
- ä¿®æ”¹é”šç‚¹åï¼Œæ—§çš„åŒå‘¨æœŸæ•°æ®ä»ç„¶æœ‰æ•ˆ
- éœ€è¦ç­‰å¾…æ•°å‘¨ç›´åˆ°`end_date`è¿‡æœŸæ‰ä¼šé‡æ–°ç”Ÿæˆ
- ç”¨æˆ·çœ‹åˆ°çš„ä»æ˜¯æ—§å‘¨æœŸçš„æ•°æ®

---

### é—®é¢˜3: é»„ä½“æœŸå¾®è°ƒç®—æ³• ğŸŸ¢

**ç®—æ³•é€»è¾‘**: [`core/state_manager.py:469-473`](core/state_manager.py:469)

```python
elif stage == "luteal":
    # é»„ä½“æœŸï¼šåæœŸå½±å“æ›´å¼ºï¼ˆPMSç—‡çŠ¶ï¼‰
    intensity = 0.7 + (current_day / max(phase_duration, 1)) * 0.3
    physical_impact = min(physical_base * intensity, 0.8)
    psychological_impact = min(psychological_base * intensity, 0.7)
```

**é»„ä½“æœŸç¬¬14å¤©**ï¼ˆæœ€åä¸€å¤©ï¼‰æ—¶ï¼š
- `day_in_phase = 14`, `phase_duration = 14`
- `intensity = 0.7 + (14/14) Ã— 0.3 = 1.0` ï¼ˆæœ€å¤§å¼ºåº¦ï¼‰

**ç¤ºä¾‹è®¡ç®—**ï¼š

| ç­‰çº§é…ç½® | physical_base | æœ€ç»ˆimpact | è½¬æ¢å›ç­‰çº§ | æ˜¾ç¤ºçŠ¶æ€ |
|---------|---------------|-----------|----------|---------|
| level=4 | 0.33 | 0.33Ã—1.0=0.33 | 4 | è¾ƒæ˜æ˜¾çš„ç–²åŠ³ |
| level=2 | 0.11 | 0.11Ã—1.0=0.11 | 2 | å¶æœ‰è½»å¾®ç–²æƒ« |

è¿™è§£é‡Šäº†ä¸ºä»€ä¹ˆä¿®æ”¹ç­‰çº§é…ç½®å"ä»ç´¯å˜æ­£å¸¸"ã€‚

---

### é—®é¢˜4: çŠ¶æ€ç¼“å­˜ ğŸŸ¡

**ç¼“å­˜é€»è¾‘**: [`core/state_manager.py:395-397`](core/state_manager.py:395)

```python
if self.last_calculated_date == today.date() and self.current_state:
    return self.current_state  # åŒä¸€å¤©è¿”å›ç¼“å­˜
```

**åæœ**ï¼š
- åŒä¸€å¤©å†…å¤šæ¬¡æŸ¥è¯¢è¿”å›ç¼“å­˜ç»“æœ
- å³ä½¿ä¿®æ”¹äº†é…ç½®ï¼Œä¹Ÿä¸ä¼šç«‹å³é‡æ–°è®¡ç®—

---

## ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤1: è‡ªåŠ¨åŒæ­¥é…ç½®åˆ°Storage âœ…

**æ–°å¢æ–¹æ³•**: `DualCycleManager._sync_anchor_day_from_config()`

```python
def _sync_anchor_day_from_config(self):
    """ä»é…ç½®æ–‡ä»¶åŒæ­¥é”šç‚¹æ—¥æœŸåˆ°storage"""
    if self.get_config:
        config_anchor = self.get_config("cycle.anchor_day", None)
        if config_anchor is not None:
            storage_anchor = plugin_storage.get("anchor_day", None)
            if storage_anchor != config_anchor:
                logger.info(f"åŒæ­¥é”šç‚¹æ—¥æœŸ: {storage_anchor} â†’ {config_anchor}")
                plugin_storage.set("anchor_day", config_anchor)
                # æ¸…é™¤æ—§çš„åŒå‘¨æœŸæ•°æ®ï¼Œå¼ºåˆ¶é‡æ–°ç”Ÿæˆ
                plugin_storage.delete("dual_cycle_data")
```

**å·¥ä½œæµç¨‹**ï¼š
1. æ’ä»¶å¯åŠ¨æ—¶è‡ªåŠ¨æ£€æµ‹configä¸storageçš„é”šç‚¹æ—¥æœŸ
2. å¦‚æœä¸ä¸€è‡´ï¼Œè‡ªåŠ¨åŒæ­¥åˆ°storage
3. æ¸…é™¤æ—§çš„åŒå‘¨æœŸæ•°æ®
4. ä¸‹æ¬¡æŸ¥è¯¢æ—¶è‡ªåŠ¨é‡æ–°ç”Ÿæˆ

---

### ä¿®å¤2: æ–°å¢`/set_anchor`å‘½ä»¤ âœ…

**å‘½ä»¤**: [`components/commands.py:SetAnchorDayCommand`](components/commands.py)

```python
class SetAnchorDayCommand(PlusCommand):
    command_name = "set_anchor"
    command_aliases = ["è®¾ç½®é”šç‚¹", "é”šç‚¹æ—¥æœŸ"]
```

**ä½¿ç”¨æ–¹æ³•**ï¼š
```
/set_anchor 1
/set_anchor 15
/è®¾ç½®é”šç‚¹ 20
```

**åŠŸèƒ½**ï¼š
- ä¿®æ”¹é”šç‚¹æ—¥æœŸåˆ°storage
- è‡ªåŠ¨æ¸…é™¤æ—§åŒå‘¨æœŸæ•°æ®
- ç«‹å³é‡æ–°ç”Ÿæˆæ–°å‘¨æœŸ
- æ˜¾ç¤ºæ–°å‘¨æœŸä¿¡æ¯

---

### ä¿®å¤3: æ–°å¢`/regenerate_cycle`å‘½ä»¤ âœ…

**å‘½ä»¤**: [`components/commands.py:RegenerateCycleCommand`](components/commands.py)

```python
class RegenerateCycleCommand(PlusCommand):
    command_name = "regenerate_cycle"
    command_aliases = ["é‡æ–°ç”Ÿæˆå‘¨æœŸ", "åˆ·æ–°å‘¨æœŸ"]
```

**ä½¿ç”¨æ–¹æ³•**ï¼š
```
/regenerate_cycle
/é‡æ–°ç”Ÿæˆå‘¨æœŸ
/åˆ·æ–°å‘¨æœŸ
```

**åŠŸèƒ½**ï¼š
- å¼ºåˆ¶æ¸…é™¤å½“å‰åŒå‘¨æœŸæ•°æ®
- ç«‹å³é‡æ–°ç”Ÿæˆæ–°å‘¨æœŸï¼ˆä½¿ç”¨å½“å‰é…ç½®ï¼‰
- æ¸…é™¤çŠ¶æ€ç¼“å­˜
- æ˜¾ç¤ºæ–°å‘¨æœŸä¿¡æ¯

---

### ä¿®å¤4: å¢å¼º`set_anchor_day()`å‡½æ•° âœ…

**æ›´æ–°**: [`core/state_manager.py:586-608`](core/state_manager.py:586)

```python
def set_anchor_day(day: int, force_regenerate: bool = True) -> bool:
    """
    è®¾ç½®é”šç‚¹æ—¥æœŸï¼ˆ1-31ï¼‰
    
    Args:
        force_regenerate: æ˜¯å¦ç«‹å³é‡æ–°ç”ŸæˆåŒå‘¨æœŸæ•°æ®ï¼ˆé»˜è®¤Trueï¼‰
    """
    if force_regenerate and old_anchor != day:
        # æ¸…é™¤æ—§çš„åŒå‘¨æœŸæ•°æ®ï¼Œå¼ºåˆ¶é‡æ–°ç”Ÿæˆ
        plugin_storage.delete("dual_cycle_data")
        logger.info(f"é”šç‚¹æ—¥æœŸ: {old_anchor} â†’ {day}ï¼Œå·²æ¸…é™¤æ—§å‘¨æœŸï¼Œå°†ç«‹å³é‡æ–°ç”Ÿæˆ")
```

---

### ä¿®å¤5: æ·»åŠ å¼ºåˆ¶é‡æ–°è®¡ç®—å‚æ•° âœ…

**æ›´æ–°**: [`core/state_manager.py:388-397`](core/state_manager.py:388)

```python
def calculate_current_state(self, cycle_length: int = None, force_recalc: bool = False):
    """
    Args:
        force_recalc: æ˜¯å¦å¼ºåˆ¶é‡æ–°è®¡ç®—ï¼ˆå¿½ç•¥ç¼“å­˜ï¼‰
    """
    if not force_recalc and self.last_calculated_date == today.date():
        return self.current_state
```

---

### ä¿®å¤6: æ–°å¢ç¼“å­˜ç®¡ç†æ–¹æ³• âœ…

**æ–°å¢æ–¹æ³•**: [`core/state_manager.py:567-577`](core/state_manager.py:567)

```python
def clear_cache(self):
    """æ¸…é™¤çŠ¶æ€ç¼“å­˜ï¼Œå¼ºåˆ¶ä¸‹æ¬¡æŸ¥è¯¢é‡æ–°è®¡ç®—"""
    self.last_calculated_date = None
    self.current_state = None

def force_regenerate_cycle(self):
    """å¼ºåˆ¶é‡æ–°ç”ŸæˆåŒå‘¨æœŸæ•°æ®"""
    self.cycle_manager.regenerate_cycle()
    self.clear_cache()
```

---

## ä½¿ç”¨æŒ‡å—

### åœºæ™¯1: ä¿®æ”¹é…ç½®æ–‡ä»¶åä¸ç”Ÿæ•ˆ

**é—®é¢˜**ï¼šä¿®æ”¹äº†`config.toml`ä¸­çš„`anchor_day`ï¼Œä½†çŠ¶æ€æ²¡å˜åŒ–ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. **æ–¹æ¡ˆA**ï¼šé‡å¯æ’ä»¶ï¼ˆä¼šè‡ªåŠ¨åŒæ­¥é…ç½®ï¼‰
2. **æ–¹æ¡ˆB**ï¼šä½¿ç”¨å‘½ä»¤æ‰‹åŠ¨åˆ·æ–°
   ```
   /é‡æ–°ç”Ÿæˆå‘¨æœŸ
   ```

---

### åœºæ™¯2: æƒ³å¿«é€Ÿåˆ‡æ¢é”šç‚¹æ—¥æœŸ

**éœ€æ±‚**ï¼šæµ‹è¯•ä¸åŒé”šç‚¹æ—¥æœŸçš„æ•ˆæœã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨`/set_anchor`å‘½ä»¤
```
/set_anchor 1    # è®¾ç½®ä¸ºæ¯æœˆ1å·
/æœˆç»çŠ¶æ€        # æŸ¥çœ‹æ–°çŠ¶æ€

/set_anchor 15   # æ”¹ä¸º15å·
/æœˆç»çŠ¶æ€        # æŸ¥çœ‹æ–°çŠ¶æ€
```

---

### åœºæ™¯3: æ€€ç–‘å‘¨æœŸæ•°æ®æœ‰é—®é¢˜

**ç—‡çŠ¶**ï¼šæ˜¾ç¤ºçš„é˜¶æ®µæˆ–å¤©æ•°çœ‹èµ·æ¥ä¸å¯¹ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šå¼ºåˆ¶é‡æ–°ç”Ÿæˆ
```
/regenerate_cycle  # å¼ºåˆ¶é‡æ–°ç”Ÿæˆ
/æœˆç»çŠ¶æ€          # ç¡®è®¤æ–°æ•°æ®
```

---

## æŠ€æœ¯ç»†èŠ‚

### æ•°æ®æµå‘

```
ä¿®æ”¹config.toml
    â†“
æ’ä»¶å¯åŠ¨/é‡è½½
    â†“
_sync_anchor_day_from_config()  â† è‡ªåŠ¨åŒæ­¥
    â†“
æ£€æµ‹config != storage
    â†“
plugin_storage.set("anchor_day", config_value)
    â†“
plugin_storage.delete("dual_cycle_data")  â† æ¸…é™¤ç¼“å­˜
    â†“
ä¸‹æ¬¡æŸ¥è¯¢æ—¶è‡ªåŠ¨é‡æ–°ç”Ÿæˆ
```

### å‘½ä»¤æ‰§è¡Œæµç¨‹

```
/set_anchor 1
    â†“
SetAnchorDayCommand.execute()
    â†“
set_anchor_day(1, force_regenerate=True)
    â†“
plugin_storage.set("anchor_day", 1)
plugin_storage.delete("dual_cycle_data")
    â†“
DualCycleManager._generate_new_cycle()  â† ç«‹å³ç”Ÿæˆ
    â†“
è¿”å›æ–°å‘¨æœŸä¿¡æ¯
```

---

## æµ‹è¯•éªŒè¯

### æµ‹è¯•1: é…ç½®åŒæ­¥

1. ä¿®æ”¹`config.toml`: `anchor_day = 5`
2. é‡å¯æ’ä»¶
3. æ‰§è¡Œ`/æœˆç»çŠ¶æ€`
4. âœ… åº”è¯¥çœ‹åˆ°æ–°çš„å‘¨æœŸæ•°æ®ï¼ˆåŸºäº5å·é”šç‚¹ï¼‰

### æµ‹è¯•2: å‘½ä»¤ä¿®æ”¹

1. æ‰§è¡Œ`/set_anchor 10`
2. æŸ¥çœ‹è¿”å›æ¶ˆæ¯ç¡®è®¤ä¿®æ”¹æˆåŠŸ
3. æ‰§è¡Œ`/æœˆç»çŠ¶æ€`
4. âœ… åº”è¯¥çœ‹åˆ°æ–°çš„å‘¨æœŸæ•°æ®ï¼ˆåŸºäº10å·é”šç‚¹ï¼‰

### æµ‹è¯•3: å¼ºåˆ¶åˆ·æ–°

1. ä¿®æ”¹ç­‰çº§é…ç½®ï¼ˆå¦‚`luteal_physical = 2`ï¼‰
2. æ‰§è¡Œ`/regenerate_cycle`
3. æ‰§è¡Œ`/æœˆç»çŠ¶æ€`
4. âœ… åº”è¯¥çœ‹åˆ°ç­‰çº§=2çš„çŠ¶æ€æè¿°

---

## ä¿®å¤æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|------|---------|
| `core/state_manager.py` | â€¢ æ·»åŠ `_sync_anchor_day_from_config()`<br>â€¢ æ·»åŠ `clear_cache()`å’Œ`force_regenerate_cycle()`<br>â€¢ `DualCycleManager`æ”¯æŒé…ç½®å‡½æ•°<br>â€¢ `calculate_current_state()`æ”¯æŒ`force_recalc`<br>â€¢ å¢å¼º`set_anchor_day()`æ”¯æŒç«‹å³é‡æ–°ç”Ÿæˆ |
| `components/commands.py` | â€¢ æ–°å¢`SetAnchorDayCommand`<br>â€¢ æ–°å¢`RegenerateCycleCommand` |
| `plugin.py` | â€¢ æ³¨å†Œæ–°å‘½ä»¤åˆ°ç»„ä»¶åˆ—è¡¨ |

---

## æ€»ç»“

### é—®é¢˜æ ¹æº
1. Configä¸Storageä¸åŒæ­¥å¯¼è‡´é”šç‚¹ä¿®æ”¹ä¸ç”Ÿæ•ˆ
2. åŒå‘¨æœŸæ•°æ®ç¼“å­˜æœºåˆ¶å¯¼è‡´ä¿®æ”¹å»¶è¿Ÿç”Ÿæ•ˆ
3. é»„ä½“æœŸåæœŸçš„å¾®è°ƒç®—æ³•æ”¾å¤§äº†ç­‰çº§å·®å¼‚

### è§£å†³æ–¹æ¡ˆ
1. âœ… è‡ªåŠ¨åŒæ­¥é…ç½®åˆ°Storage
2. âœ… æä¾›å‘½ä»¤æ‰‹åŠ¨åˆ·æ–°å‘¨æœŸ
3. âœ… å¢å¼ºç¼“å­˜æ¸…ç†æœºåˆ¶
4. âœ… æ”¯æŒå¼ºåˆ¶é‡æ–°è®¡ç®—

### ç”¨æˆ·ä½“éªŒæ”¹è¿›
- ğŸ¯ ä¿®æ”¹é…ç½®åç«‹å³ç”Ÿæ•ˆï¼ˆé‡å¯æ’ä»¶æ—¶ï¼‰
- ğŸ¯ æä¾›`/set_anchor`å‘½ä»¤å¿«é€Ÿåˆ‡æ¢
- ğŸ¯ æä¾›`/regenerate_cycle`å‘½ä»¤å¼ºåˆ¶åˆ·æ–°
- ğŸ¯ æ¸…æ™°çš„åé¦ˆæ¶ˆæ¯

---

**ä¿®å¤å®Œæˆæ—¥æœŸ**: 2025-12-15  
**å½±å“èŒƒå›´**: åŒå‘¨æœŸé”šå®šæ¨¡å‹ã€çŠ¶æ€ç¼“å­˜ã€é…ç½®åŒæ­¥