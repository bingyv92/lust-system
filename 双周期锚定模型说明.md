# 双周期锚定模型迁移说明

## 版本信息

- **旧版本**: 单周期固定日期模型（v2.x）
- **新版本**: 双周期锚定模型（v3.0）
- **迁移日期**: 2025-12-14

---

## 核心变化

### 1. 周期计算模型升级

#### 旧版本（单周期模型）
- 基于"上次月经开始日期"计算
- 使用固定的周期长度（如28天）
- 需要手动设置和更新月经日期
- 跨月份时容易产生偏差

#### 新版本（双周期锚定模型）
- 基于每月固定"锚点日期"（如15号）
- 自动生成两个连续的周期（第一周期 + 第二周期）
- 每个周期长度随机在25-35天之间
- 月经天数随机在3-7天之间
- 周期自动循环，无需手动维护

### 2. 锚点机制

**锚点日期**是每月的固定日期（1-31号），作为周期计算的基准点。

例如：
- 锚点设为15号
- 从本月15号到下月15号为一个完整的双周期
- 系统自动生成两个周期并分配阶段

### 3. 阶段分配算法

每个周期固定分为4个阶段：

| 阶段 | 持续时间 | 计算规则 |
|------|---------|---------|
| 月经期 | 3-7天（随机） | 周期开始的前N天 |
| 卵泡期 | 可变 | 剩余天数 - 16天 |
| 排卵期 | 2天（固定） | 卵泡期后2天 |
| 黄体期 | 14天（固定） | 周期结束前14天 |

---

## 淫乱度系统更新

### 月经期强制关闭淫乱度

**重要变化**：月经期现在会强制关闭淫乱度系统。

#### 实现位置

1. **LustSystem (`core/lust_system.py`)** - Line 20-51
   ```python
   def calculate_lust_level(self, period_state: Dict[str, Any]) -> float:
       stage = period_state.get("stage", "follicular")
       
       # ⚠️ 月经期强制关闭淫乱度系统
       if stage == "menstrual":
           logger.info(f"[淫乱度计算] 月经期检测到，强制返回0.0（禁用淫乱度）")
           return 0.0
   ```

2. **PeriodStatePrompt (`components/prompts.py`)** - Line 226-241
   ```python
   # ⚠️ 月经期强制关闭淫乱度系统
   if state["stage"] == "menstrual":
       logger.info(f"[提示词淫乱度] 月经期检测到，强制关闭淫乱度系统")
       lust_enabled = False
   ```

#### 行为说明

- 月经期间，淫乱度固定为 **0.0**
- 月经期间，**不会**生成淫乱度相关的性欲指导
- 月经期间，性欲提示词完全由月经周期系统控制
- 月经期结束后，淫乱度系统自动恢复正常

---

## API变化

### 废弃的API

以下API在双周期模型中已废弃，仅为兼容性保留：

```python
# ❌ 已废弃
get_last_period_date()  # 获取上次月经日期
set_last_period_date(date_str)  # 设置月经日期
```

### 新增API

```python
# ✅ 新API
set_anchor_day(day: int)  # 设置锚点日期（1-31）
```

### 更新的API

```python
# calculate_current_state() 参数变化
# 旧版：需要传入 cycle_length
state_manager.calculate_current_state(cycle_length=28)

# 新版：cycle_length 参数已废弃（自动计算）
state_manager.calculate_current_state()  # 推荐
state_manager.calculate_current_state(28)  # 仍可用，但被忽略
```

---

## 数据存储变化

### 旧版存储结构

```json
{
  "last_period_date": "2024-12-01"
}
```

### 新版存储结构

```json
{
  "anchor_day": 15,
  "dual_cycle_data": {
    "anchor_day": 15,
    "start_date": "2024-12-15T00:00:00",
    "end_date": "2025-01-15T00:00:00",
    "cycle1_length": 28,
    "cycle2_length": 30,
    "cycle1_menstrual_days": 5,
    "cycle2_menstrual_days": 4,
    "total_days": 58
  }
}
```

---

## 配置变化

### config.toml 更新

旧版配置：
```toml
[cycle]
cycle_length = 28  # 周期长度

[period_tracking]
last_period_date = "2024-12-01"  # 上次月经日期
```

新版配置：
```toml
[cycle]
anchor_day = 15  # 锚点日期（1-31）

# 不再需要 last_period_date 和 cycle_length
# 系统会自动生成和管理双周期数据
```

---

## 命令变化

### 查询命令保持不变

```
/period
/月经状态
/周期状态
```

### 新增命令

```
/regenerate_cycle
/重新生成周期
/刷新周期
```

强制重新生成双周期数据，适用于：
- 想要重新随机化周期长度
- 觉得当前周期不合适
- 测试不同周期配置

### 废弃命令

```
/set_period YYYY-MM-DD  # ❌ 已移除
/设置月经日期 YYYY-MM-DD  # ❌ 已移除
```

---

## 迁移步骤

### 自动迁移

插件会自动处理迁移，无需手动操作：

1. 首次启动时检测到旧版数据
2. 自动生成双周期数据
3. 保留旧配置作为备份
4. 使用新模型开始运行

### 手动配置（可选）

如果想自定义锚点日期：

1. 编辑 `config.toml`
2. 设置 `[cycle] anchor_day = X`（X为1-31）
3. 重启插件或使用 `/regenerate_cycle` 命令

---

## 常见问题

### Q: 为什么要改用双周期模型？

**A:** 主要优势：
- ✅ 更符合生理规律（周期长度有变化）
- ✅ 无需手动维护月经日期
- ✅ 自动循环，永不过期
- ✅ 跨月份计算更准确
- ✅ 随机性增加真实感

### Q: 旧的数据会丢失吗？

**A:** 不会。旧数据会被保留作为备份，但不再使用。新模型会自动生成新的周期数据。

### Q: 如何调整周期长度？

**A:** 新模型中周期长度是随机生成的（25-35天）。如果不满意当前周期，可以使用 `/regenerate_cycle` 命令重新生成。

### Q: 月经期关闭淫乱度会影响什么？

**A:** 
- 月经期间淫乱度固定为0
- 不会触发高潮系统
- 性欲提示词完全由月经周期控制
- 月经期结束后自动恢复

### Q: 锚点日期如何选择？

**A:** 
- 默认值：15号（月中）
- 建议选择：5-25号之间
- 避免月底（28-31号），可能在某些月份失效

### Q: 双周期如何工作？

**A:** 
- 从锚点A到锚点B是一个完整的双周期
- 包含两个独立的月经周期
- 每个周期都有完整的4个阶段
- 到期后自动生成新的双周期

---

## 技术实现细节

### 核心类

1. **DualCycleManager** - 双周期数据管理
   - 生成和存储双周期数据
   - 计算当前所在阶段
   - 自动检测和更新过期周期

2. **CyclePhase** - 阶段数据结构
   - 阶段名称（英文/中文）
   - 阶段持续时间
   - 阶段内第几天

3. **DualCycleData** - 双周期数据结构
   - 锚点日期
   - 起止时间
   - 两个周期的参数

### 算法流程

```
1. 检查当前日期
2. 确定当前锚点周期
3. 计算距离起始锚点的天数
4. 判断在第一周期还是第二周期
5. 在周期内确定当前阶段
6. 返回阶段信息和影响值
```

---

## 兼容性说明

- **向后兼容**：旧版API仍可调用（会显示警告）
- **配置兼容**：旧配置不会导致错误
- **数据迁移**：自动且无感知
- **命令兼容**：查询命令保持不变

---

## 更新日志

### v3.0.0 (2025-12-14)

**新功能**
- ✨ 双周期锚定模型
- ✨ 自动周期生成和循环
- ✨ 月经期强制关闭淫乱度
- ✨ `/regenerate_cycle` 命令

**改进**
- 🎯 更准确的跨月计算
- 🎲 增加随机性和真实感
- 🔧 简化配置和维护

**废弃**
- ❌ 移除 `/set_period` 命令
- ⚠️ 废弃 `get_last_period_date()` API
- ⚠️ 废弃 `set_last_period_date()` API

---

## 支持

如有问题请查看：
- 插件开发指南.txt
- lust_system_architecture.md
- KFC集成问题诊断.md

或在GitHub仓库提Issue。