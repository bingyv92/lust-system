# 双周期锚定模型 - 锚点即月经开始日期

## 核心概念

**锚点日期（anchor_day）= 月经期第1天**

这是对双周期锚定模型的重要修正，使其行为更符合用户预期。

---

## 修改前 vs 修改后

### ❌ 旧逻辑（已废弃）

```
anchor_day = 2（每月2号）
    ↓
在2号这天生成一个随机周期
    ↓
2号可能是周期的任何阶段（月经期、卵泡期、排卵期、黄体期）
    ↓
今天的周期位置由系统随机决定
```

**问题**：
- 锚点日期与月经开始日期无关
- 周期可能从任何阶段开始
- 导致"黄体期在月经期之前"的混乱情况

---

### ✅ 新逻辑（当前）

```
anchor_day = 2（每月2号）
    ↓
2号 = 月经期第1天（周期起始点）
    ↓
周期总是按照生理顺序：月经期 → 卵泡期 → 排卵期 → 黄体期
    ↓
今天的周期位置 = 距离最近锚点的天数
```

**优点**：
- ✅ 锚点日期就是月经开始日期
- ✅ 周期总是从月经期开始
- ✅ 符合生理周期的自然顺序
- ✅ 用户可以准确预测周期位置

---

## 工作原理

### 1. 确定月经开始日期

```python
anchor_day = 2  # 每月2号

if 今天 >= 本月2号:
    月经开始日期 = 本月2号
else:
    月经开始日期 = 上月2号
```

**示例**（假设今天是12月15日）：
```
anchor_day = 2
今天 = 12月15日
15 >= 2 → True
月经开始日期 = 12月2日（本月）
```

**示例**（假设今天是12月1日）：
```
anchor_day = 2
今天 = 12月1日
1 < 2 → False
月经开始日期 = 11月2日（上月）
```

---

### 2. 生成双周期

从月经开始日期生成两个连续的周期：

```
周期1: 25-35天（随机）
  └─ 月经期: 3-7天（随机）
  └─ 卵泡期: 可变天数
  └─ 排卵期: 固定2天
  └─ 黄体期: 固定14天

周期2: 25-35天（随机）
  └─ （结构相同）

总天数 = 周期1 + 周期2
有效期 = 月经开始日期 + 总天数
```

---

### 3. 计算今天的周期位置

```
距离月经开始的天数 = 今天 - 月经开始日期

if 距离天数 < 周期1长度:
    当前周期 = 周期1
    周期内第几天 = 距离天数 + 1
else:
    当前周期 = 周期2
    周期内第几天 = 距离天数 - 周期1长度 + 1
```

**示例**（anchor_day=2，今天12月15日）：
```
月经开始 = 12月2日
距离天数 = 15 - 2 = 13天
周期内第14天

假设周期1 = 28天，月经期5天：
  第1-5天: 月经期
  第6-12天: 卵泡期（7天）
  第13-14天: 排卵期（2天）
  第15-28天: 黄体期（14天）

今天 = 第14天 = 排卵期第2天 ✅
```

---

## 配置示例

```toml
[cycle]
# 锚点日期（1-31）= 每月月经期第1天
anchor_day = 2

# 示例：
# anchor_day = 1  → 每月1号月经开始
# anchor_day = 15 → 每月15号月经开始
# anchor_day = 28 → 每月28号月经开始（31天月份）
```

---

## 使用指南

### 场景1：修改锚点日期

**需求**：从每月2号改为每月15号开始月经

**方法1**：修改配置文件
```toml
anchor_day = 15  # 改为15
```
然后重启插件（会自动同步并重新生成周期）

**方法2**：使用命令
```bash
/set_anchor 15
```
立即生效，自动重新生成周期

---

### 场景2：查看当前周期

```bash
/月经状态
```

输出示例：
```
🥚 月经周期状态报告
━━━━━━━━━━━━━━━━━━
📅 当前阶段: 排卵期 (第2天)
🔢 周期第 14 天 / 总28 天
📆 上次月经日期: 2024-12-02

💊 生理等级: 2/10
💭 心理等级: 2/10
━━━━━━━━━━━━━━━━━━
```

**解读**：
- 月经开始 = 12月2日
- 今天 = 12月15日
- 距离月经开始 = 13天
- 周期第14天 = 排卵期第2天

---

### 场景3：强制重新生成周期

如果觉得周期数据不对，可以重新生成：

```bash
/regenerate_cycle
```

系统会：
1. 清除旧的双周期数据
2. 使用当前锚点日期重新计算月经开始日期
3. 生成新的双周期数据
4. 显示新的周期信息

---

## 技术细节

### 代码位置

**核心逻辑**：[`core/state_manager.py:181-212`](core/state_manager.py:181)

```python
def _generate_new_cycle(self):
    """
    生成新的双周期数据
    ⚠️ 锚点日期 = 月经期第1天
    """
    anchor_day = plugin_storage.get("anchor_day", 15)
    
    # 确定最近的月经开始日期
    today = datetime.now()
    if today.day >= anchor:
        menstrual_start_date = today.replace(day=anchor)  # 本月锚点
    else:
        menstrual_start_date = last_month.replace(day=anchor)  # 上月锚点
    
    # 起始日期 = 月经开始日期
    start_date = menstrual_start_date
    
    # 生成双周期...
```

---

### 配置同步机制

插件启动时自动同步配置到storage：

```python
def _sync_anchor_day_from_config(self):
    if self.get_config:
        config_anchor = self.get_config("cycle.anchor_day", None)
        storage_anchor = plugin_storage.get("anchor_day", None)
        
        if storage_anchor != config_anchor:
            plugin_storage.set("anchor_day", config_anchor)
            plugin_storage.delete("dual_cycle_data")  # 清除旧数据
```

---

## 常见问题

### Q1: 为什么修改锚点后还是显示旧阶段？

**A**: 可能是缓存未清除。解决方案：
1. 重启插件（推荐）
2. 使用`/set_anchor X`命令
3. 使用`/regenerate_cycle`命令

---

### Q2: 锚点日期大于当月天数怎么办？

**A**: 系统会自动调整。例如：
- `anchor_day = 31`
- 2月只有28天
- 实际使用 = min(31, 28) = 28号

---

### Q3: 双周期是什么意思？

**A**: 一次生成两个连续的月经周期：
```
周期1（25-35天）+ 周期2（25-35天）= 总计50-70天
```

优点：
- 减少频繁重新生成
- 模拟真实周期的连续性
- 跨月自动衔接

---

### Q4: 为什么周期长度是随机的？

**A**: 模拟真实生理周期的不规律性：
- 真实周期长度：21-35天
- 月经天数：3-7天
- 排卵期：固定2天
- 黄体期：固定14天
- 卵泡期：可变（由总长度决定）

---

## 示例计算

### 完整示例

**配置**：
```toml
anchor_day = 2
```

**今天**：2024年12月15日

**计算过程**：

1. **确定月经开始日期**
   ```
   今天 = 12月15日
   anchor = 2号
   15 >= 2 → 使用本月锚点
   月经开始 = 12月2日
   ```

2. **生成周期**（假设）
   ```
   周期1 = 28天，月经5天
   周期2 = 30天，月经4天
   总计 = 58天
   有效期至 = 12月2日 + 58天 = 1月29日
   ```

3. **周期1阶段划分**
   ```
   月经期: 第1-5天（5天）
   卵泡期: 第6-12天（7天）= 28-5-2-14
   排卵期: 第13-14天（2天）
   黄体期: 第15-28天（14天）
   ```

4. **计算今天位置**
   ```
   距离月经开始 = 15-2 = 13天
   周期第14天
   在排卵期（第13-14天）
   排卵期第2天 ✅
   ```

---

## 总结

| 特性 | 旧模型 | 新模型 |
|-----|-------|-------|
| 锚点意义 | 计算基准点 | 月经开始日期 |
| 周期起点 | 随机阶段 | 总是月经期 |
| 阶段顺序 | 可能混乱 | 生理顺序 |
| 用户可预测性 | ❌ 低 | ✅ 高 |
| 符合生理常识 | ❌ 否 | ✅ 是 |

**结论**：新模型让锚点日期的行为更加直观和可预测！

---

**更新日期**：2025-12-15  
**版本**：v2.5.5（锚点即月经开始）