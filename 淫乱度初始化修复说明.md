# 淫乱度初始化问题修复说明

## 问题诊断

### 根本原因
用户数据使用旧逻辑初始化后，存在两个问题：
1. **初始化时硬编码淫乱度=0.3**：无论何时初始化，都按最低淫乱度计算初始高潮值
2. **更新时不重算高潮值**：`update_lust_from_period_state` 更新淫乱度，但不重新计算高潮值

### 实际数据证据
```json
{
  "lust_level": 0.46,      // 黄体期，淫乱度已更新
  "orgasm_value": 0.0,     // 但高潮值还是0，导致判定错误
  "current_stage": "被动未开始"  // ❌ 错误的阶段
}
```

## 修复方案

### 1. 动态计算初始淫乱度
**文件**: `lust_system.py` - `_create_default_user_data()`

**修改前**:
```python
lust_level = 0.3  # 硬编码
```

**修改后**:
```python
if period_state:
    lust_level = self.calculate_lust_level(period_state)  # 动态计算
else:
    lust_level = 0.3  # 回退默认值
```

### 2. 更新时重新初始化过低的高潮值
**文件**: `lust_system.py` - `update_lust_from_period_state()`

**新增逻辑**:
```python
# 如果高潮值低于被动阈值，说明可能是旧数据，重新初始化
if old_orgasm_value < passive_threshold:
    initial_ratio = self._get_config("lust_system.initial_ratio", 0.5)
    new_orgasm_value = lust_level * foreplay_threshold * initial_ratio
    data["orgasm_value"] = new_orgasm_value
    data["current_stage"] = self._determine_stage(new_orgasm_value)
```

### 3. 清理旧数据
运行 `reset_user_data.py` 删除所有旧的用户数据，下次对话将使用新逻辑重新初始化。

## 修复效果

### 排卵期（淫乱度0.9）
**配置**: 
- `foreplay_threshold = 30.0`
- `initial_ratio = 0.5`
- `passive_active_ratio = 0.2`
- 被动/主动阈值 = 6.0

**修复前**:
```
初始高潮值 = 0.3 × 30 × 0.5 = 4.5
判定阶段: 被动未开始 ❌
```

**修复后**:
```
初始高潮值 = 0.9 × 30 × 0.5 = 13.5
判定阶段: 主动未开始 ✅
```

### 黄体期（淫乱度0.5）
**修复前**:
```
初始高潮值 = 0.3 × 30 × 0.5 = 4.5
判定阶段: 被动未开始 ❌
```

**修复后**:
```
初始高潮值 = 0.5 × 30 × 0.5 = 7.5
判定阶段: 主动未开始 ✅
```

## 使用说明

### 方式1：清理旧数据（推荐）
```powershell
# 删除所有旧数据，下次对话重新初始化
python plugins\mofox_period_plugin\reset_user_data.py
```

### 方式2：自动修复
如果用户数据的 `orgasm_value < passive_threshold`（被动阈值），系统会在下次 LLM 评分时自动重新初始化。

只需正常发送一条消息触发评分，系统会自动检测并修复。

### 方式3：使用命令重置
```
/period.lust_status reset
```

## 验证方法

1. **发送消息触发评分**
2. **检查日志**，应该看到：
   ```
   [淫乱度更新] 用户xxx: 0.46→0.90, 
   重新初始化高潮值: 0.0→13.5, 
   阶段: 主动未开始
   ```

3. **查询状态**：
   ```
   /period.lust_status
   ```
   应该显示正确的阶段（不再是"被动未开始"）

## 配置调整建议

如果希望排卵期直接进入"前戏"阶段，可以调整：

```toml
[lust_system]
initial_ratio = 1.0  # 从0.5增加到1.0
```

**效果**:
- 排卵期初始高潮值: 0.9 × 30 × 1.0 = 27.0 → **前戏阶段**
- 黄体期初始高潮值: 0.5 × 30 × 1.0 = 15.0 → **主动未开始**

## 技术细节

### 修改的文件
1. `plugins/mofox_period_plugin/core/lust_system.py`
   - `_create_default_user_data()` - 动态计算淫乱度
   - `get_user_data()` - 接收 period_state 参数
   - `update_lust_from_period_state()` - 重新初始化过低的高潮值
   - `process_score()` - 接收 period_state 参数

2. `plugins/mofox_period_plugin/components/lust_scoring_handler.py`
   - 调用 `process_score()` 时传递 `period_state`

3. `plugins/mofox_period_plugin/components/commands.py`
   - 调用 `get_user_data()` 时传递 `period_state`

4. `plugins/mofox_period_plugin/components/prompts.py`
   - 调用 `get_user_data()` 时传递 `period_state`

### 兼容性
- ✅ 向后兼容：旧数据会自动修复
- ✅ 不影响现有功能：只是修正初始化逻辑
- ✅ 配置生效：`passive_active_ratio` 和 `initial_ratio` 现在能正确工作
