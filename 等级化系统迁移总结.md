# 等级化系统迁移总结

## 迁移目标 ✅

将月经周期插件从**浮点数影响值系统**（0.0-1.0）完全迁移到**整数等级系统**（1-10）。

---

## 核心变更

### 1. 配置系统 (`config_schema.py`)

**旧配置结构**（已废弃）：
```python
"impacts": {
    "menstrual_physical": 0.7,
    "menstrual_psychological": 0.6,
    ...
}
"cycle": {
    "cycle_length": 28  # 固定周期长度
}
```

**新配置结构**：
```python
"levels": {
    "menstrual_physical": ConfigField(int, default=5, min_value=1, max_value=10),
    "menstrual_psychological": ConfigField(int, default=4, min_value=1, max_value=10),
    "follicular_physical": ConfigField(int, default=2, ...),
    "follicular_psychological": ConfigField(int, default=2, ...),
    "ovulation_physical": ConfigField(int, default=3, ...),
    "ovulation_psychological": ConfigField(int, default=2, ...),
    "luteal_physical": ConfigField(int, default=4, ...),
    "luteal_psychological": ConfigField(int, default=3, ...)
}
"cycle": {
    "anchor_day": ConfigField(int, default=15, min_value=1, max_value=31)
}
```

**等级语义**：
- **1-2级**：状态良好，正面影响（增强淫乱度）
- **3级**：中性状态（基准线）
- **4-10级**：状态不佳，负面影响（抑制淫乱度）

---

### 2. State字典结构 (`core/state_manager.py`)

**移除的旧字段**：
```python
"physical_impact": 0.7,      # ❌ 已删除
"psychological_impact": 0.6,  # ❌ 已删除
```

**保留的新字段**：
```python
"physical_level": 5,          # ✅ 整数等级 (1-10)
"psychological_level": 4,     # ✅ 整数等级 (1-10)
"dysmenorrhea_level": 2,      # ✅ 痛经等级 (0-10)
```

**痛经等级分布**（新增）：
- **0级**（无痛经）：20%概率
- **1-3级**（轻度痛经）：70%概率
- **4-6级**（中度痛经）：10%概率

---

### 3. 提示词系统 (`core/state_manager.py:18-77`)

**PromptTemplates类** - 客观中性的等级描述：

```python
class PromptTemplates:
    PHYSICAL_TEMPLATES = {
        1: "身体状态良好，精力充沛。",
        2: "身体状态正常，偶有轻微疲惫。",
        3: "有轻度疲劳感，腰腹略有不适。",
        ...
        10: "身体状况极差，需要医疗关注。"
    }
    
    PSYCHOLOGICAL_TEMPLATES = {
        1: "情绪稳定，心情平和。",
        2: "情绪基本稳定，偶有小波动。",
        ...
        10: "情绪状态很差，需要特别关注。"
    }
    
    DYSMENORRHEA_TEMPLATES = {
        0: "无痛经症状。",
        1: "有非常轻微的下腹不适。",
        ...
        10: "疼痛极其剧烈，需要紧急医疗。"
    }
```

**设计原则**：
- 客观描述，避免主观判断
- 等级递增与症状强度线性对应
- 为LLM提供准确的生理/心理状态参考

---

### 4. 淫乱度计算算法 (`core/lust_system.py:20-90`)

**新算法公式**：
```python
淫乱度 = 基础淫乱度(阶段) × 生理调节因子(等级) × 心理调节因子(等级)
```

**基础淫乱度**（由周期阶段决定）：
```python
{
    "menstrual": 0.0,    # 月经期强制关闭
    "follicular": 0.3,   # 卵泡期
    "ovulation": 0.9,    # 排卵期（峰值）
    "luteal": 0.5        # 黄体期
}
```

**等级调节因子映射**（`_calculate_level_factor()`）：
```python
level 1  → 1.2  (增强20%)
level 2  → 1.1  (增强10%)
level 3  → 1.0  (中性基准)
level 4  → 0.93
level 5  → 0.86
level 6  → 0.79
level 7  → 0.71
level 8  → 0.64
level 9  → 0.57
level 10 → 0.5  (抑制50%)
```

**公式**：
- level ≤ 3: `factor = 1.0 + (3 - level) × 0.1`
- level > 3: `factor = max(0.5, 1.0 - (level - 3) × 0.0714)`

**示例计算**：
```python
# 排卵期 + 生理2级 + 心理2级
lust = 0.9 × 1.1 × 1.1 = 1.089 → 截断到1.0

# 黄体期 + 生理4级 + 心理3级
lust = 0.5 × 0.93 × 1.0 = 0.465 → 0.47
```

---

### 5. 配置验证 (`plugin.py:139-156`)

**新的验证逻辑**：
```python
def _validate_critical_configs(self):
    # 验证锚点日期
    anchor_day = self.get_config("cycle.anchor_day", 15)
    if not isinstance(anchor_day, int) or anchor_day < 1 or anchor_day > 31:
        self.set_config("cycle.anchor_day", 15)
    
    # 验证等级配置（1-10整数）
    for stage in ["menstrual", "follicular", "ovulation", "luteal"]:
        for level_type in ["physical", "psychological"]:
            key = f"levels.{stage}_{level_type}"
            value = self.get_config(key, 5)
            if not isinstance(value, int) or value < 1 or value > 10:
                self.set_config(key, 5)  # 重置为中性默认值
```

---

### 6. 命令状态报告 (`components/commands.py:50-110`)

**显示格式变更**：

**旧格式**（已废弃）：
```
生理影响: 0.70
心理影响: 0.60
```

**新格式**：
```
生理等级: 5 (疲劳感较强，腰腹持续不适，需要更多休息。)
心理等级: 4 (情绪波动明显，耐心有所下降。)
痛经等级: 2 (有轻微的下腹疼痛感。)
```

---

### 7. Prompt注入 (`components/prompts.py`)

**等级化描述应用**：

```python
# 获取等级
physical_level = period_state.get("physical_level", 3)
psychological_level = period_state.get("psychological_level", 3)
dysmenorrhea_level = period_state.get("dysmenorrhea_level", 0)

# 获取客观描述
physical_desc = PromptTemplates.get_physical_prompt(physical_level)
psychological_desc = PromptTemplates.get_psychological_prompt(psychological_level)
dysmenorrhea_desc = PromptTemplates.get_dysmenorrhea_prompt(dysmenorrhea_level)
```

**KFC模式命令性指导**（保留原有风格）：
```python
if stage == "menstrual":
    return "你应避免主动性接触，需要温柔照顾。"
elif stage == "ovulation":
    return "你可以接受并享受亲密互动，但需要真诚的情感连接。"
...
```

---

## 兼容性保留

### 内部计算方法

虽然对外接口完全使用等级，但内部保留了浮点数转换方法用于微调计算：

```python
# state_manager.py
def _level_to_impact(self, level: int) -> float:
    """等级(1-10) → 影响值(0.0-1.0)"""
    return (level - 1) / 9.0

def _impact_to_level(self, impact: float) -> int:
    """影响值(0.0-1.0) → 等级(1-10)"""
    level = int(impact * 9) + 1
    return max(1, min(10, level))

def _calculate_impacts(self, stage, current_day, phase_duration):
    """从配置读取等级，转换为影响值用于内部微调算法"""
    # 1. 读取等级配置
    physical_level = self.get_config(f"levels.{stage}_physical", 5)
    
    # 2. 转换为影响值
    physical_base = self._level_to_impact(physical_level)
    
    # 3. 应用微调（月经期前期强、黄体期后期强）
    if stage == "menstrual":
        intensity = 1.0 - (day_in_stage - 1) / max(phase_duration, 1) * 0.3
        physical_impact = physical_base * intensity
    
    # 4. 转回等级供外部使用
    return physical_impact, psychological_impact
```

### 旧版兼容字段

State字典保留了部分旧版字段用于向后兼容：
```python
"current_day": day_in_cycle,    # 兼容旧版
"cycle_length": total_days,     # 兼容旧版
```

---

## 迁移检查清单

- [x] 更新配置schema（impacts → levels）
- [x] 更新PeriodStateManager读取等级配置
- [x] 移除state字典中的旧浮点数字段
- [x] 添加PromptTemplates等级描述系统
- [x] 重构淫乱度计算算法（基于等级因子）
- [x] 更新命令状态报告（显示等级）
- [x] 更新Prompt生成（使用等级描述）
- [x] 添加痛经等级系统
- [x] 更新配置验证逻辑
- [x] 验证所有组件不再使用旧字段

---

## 技术优势

### 1. 用户友好性
- 整数等级比浮点数更直观（1-10 vs 0.0-1.0）
- 与日常认知一致（10级最强）

### 2. 配置精度
- 10个等级提供足够的细粒度控制
- 避免浮点数精度问题

### 3. 提示词质量
- PromptTemplates提供客观中性的描述
- 为LLM提供准确的状态参考
- 避免主观性描述影响AI判断

### 4. 可维护性
- 等级映射集中管理（PromptTemplates）
- 算法逻辑清晰（等级因子映射）
- 配置验证严格（类型+范围检查）

### 5. 扩展性
- 可轻松添加新的等级描述
- 调节因子公式可独立调整
- 等级系统可复用到其他模块

---

## 测试建议

1. **配置测试**：修改各阶段等级，观察淫乱度变化
2. **边界测试**：测试level=1和level=10的极端情况
3. **状态报告**：验证`/月经状态`命令显示正确等级
4. **Prompt质量**：检查AI是否正确理解等级描述
5. **痛经分布**：多次测试验证概率分布（20%/70%/10%）

---

## 相关文件

- `config_schema.py` - 配置定义
- `plugin.py` - 配置验证
- `core/state_manager.py` - 状态计算和PromptTemplates
- `core/lust_system.py` - 淫乱度算法
- `components/prompts.py` - Prompt生成
- `components/commands.py` - 命令处理

---

**迁移完成日期**: 2025-12-14  
**迁移版本**: v2.5.4 (等级化系统)